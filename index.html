<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title></title>
	<style>
		*{
			margin:0;
			padding:0;
		}
		.red{
			color:#ff6060;
		}
	</style>
</head>
<body>
	<div class="container1">
		<h3>Meal upgrades</h3>
		<p>Make your flight more bearable by selecting a meal to match your social and economic status.</p>
		Chosen meal: <select data-bind="options:oMeals,optionsText:'mealName',value:chosenMeal"></select>
		<p>
			You've chosen:
			<b data-bind="text:chosenMeal().description"></b>
			<div>
				(price:<span data-bind="text:FormatPrice(chosenMeal().extraCost)"></span>)
			</div>
			<div>
				(price:<span data-bind="text:formatPrice(chosenMeal().extraCost)"></span>)
			</div>
			<div>
				(price:<span data-bind="text:FormatPriceTwo"></span>)
			</div>
		</p>
		<div data-bind="text:oData.name"></div>
		<div>
			<span data-bind="click:Add">点击加一</span>
		</div>
		<div>
			<span data-bind="text:One"></span>
		</div>
		
		<div>
			<div data-bind="foreach:Meals">
				<div data-bind="text:'$'+formatPrice(extraCost)"></div>
			</div>
			<div data-bind="foreach:Meals">
				<div data-bind="text:'$'+vm.FormatPrice(extraCost)"></div>
			</div>
			<div data-bind="foreach:Meals">
				<div data-bind="text:'$'+$parent.FormatPrice(extraCost)"></div>
			</div>
			<div data-bind="foreach:Meals">
				<div data-bind="text:'$'+$root.FormatPrice(extraCost)"></div>
			</div>
		</div>
	</div>
	<div class="container2">
		<div data-bind="foreach:Meals">
			<div style="color:#ff6060;">$<span data-bind="text:formatPrice(extraCost)"></span></div>
		</div>
		<div style="color:green" data-bind="text:Name()"></div>
		<div style="color:green" data-bind="text:Age()"></div>
		<div style="color:green" data-bind="text:Work()"></div>
		<div style="font-size:20px;">
			<div data-bind="text:First"></div>
			<div data-bind="text:Last"></div>
			<div data-bind="text:First()+Last()"></div>
			<div data-bind="text:FullName()"></div>
		</div> 
		<div>
			<div>
				Enter bid price: <input type="text" data-bind="textInput:FormatPrice2"/>
			</div>
			<div data-bind="text:Price()"></div>
			<div data-bind="visible: !LastInputValid()">That's not a number!</div>
			<div data-bind="text:Data().name"></div>
		</div>
		<div data-bind="foreach:Meals">
			<div>
				<span data-bind="text:mealName"></span>******* <span data-bind="text:description"></span>************* <span data-bind="text:extraCost"></span>
			</div>
		</div>
		<div data-bind="foreach:Num">
			<!-- ko if:(name!=="a") -->
			<div data-bind="click:$parent.myNum2.bind($data,event,$index())"><span data-bind="text:name"></span></div>
			<!-- /ko -->
			<div data-bind="click:$parent.myNum" class="ddd"><!--ko text: name--><!--/ko--></div>
		</div>
		<div data-bind="foreach:Array1">
			<div style="color:#ff6060;font-size:20px;" data-bind="text:name"></div>
			<div style="color:green;font-size:18px;" data-bind="foreach:arr">
				<div data-bind="text:age"></div>
			</div>
		</div>
		<div>
			this Full is : <span data-bind="text:Full"></span>
		</div>
		<div>
			this FullName is: <span data-bind="text:FullName"></span>
		</div>
		<div>
			this PureFull is: <span data-bind="text:PureFull"></span>
		</div>
		<div>
			this MyFull is: <span data-bind="text:MyFull()"></span>
		</div>
		<div>
			<div>First name: <span data-bind="text: First"></span></div>
			<div>Last name: <span data-bind="text: Last"></span></div>
			<div class="heading">Hello, <input data-bind="textInput: fullName2"/></div>
		</div>
		<div>
			<div class="heading">
			    <input type="checkbox" data-bind="checked: selectedAllProduce" title="Select all/none"/> Produce
			</div>
			<div data-bind="foreach: produce">
			    <label>
			        <input type="checkbox" data-bind="checkedValue: $data, checked: $parent.selectedProduce"/>
			        <span data-bind="text: $data"></span>
			    </label>
			</div>
		</div>
		<div>
			<div>Enter a numeric value: <input data-bind="textInput: attemptedValue"/></div>
			<div class="error" data-bind="visible: !lastInputWasValid()">That's not a number!</div>
			<div>(Accepted value: <span data-bind="text: acceptedNumericValue"></span>)</div>
		</div>
		<div>
			<a data-bind="attr:{href:Url}">百度一下</a>
		</div>
		<div>
			<button data-bind="click: myFunction">
			    Click me
			</button>
		</div>
		
	</div>
	
<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/knockout.min.js"></script>
<script>
	var oPrice=0;
	var oFirst="xiaoming";
	var oLast="AB";
	var oData={
		name:"xiaoming",
		age:"40",
		work:"actor"
	}
	var oMeals=[
		{ mealName: 'Standard', description: 'Dry crusts of bread', extraCost: 0 },
    	{ mealName: 'Premium', description: 'Fresh bread with cheese', extraCost: 9.95 },
    	{ mealName: 'Deluxe', description: 'Caviar and vintage Dr Pepper', extraCost:18.50} 
	]
	
	var oNum=[
		{name:"a"},
		{name:"b"},
		{name:"c"}
	]
	
	var oArray=[
		{
			name:"a",
			arr:[
				{age:10},
				{age:20},
				{age:30}
			]
		},
		{
			name:"b",
			arr:[
				{age:40},
				{age:50},
				{age:60}
			]
		},
		{
			name:"c",
			arr:[
				{age:70},
				{age:80},
				{age:90}
			]
		}
	]
	
	
</script>
<script>
	var vm={
		One:ko.observable(0),
		chosenMeal:ko.observable(oMeals[0]),
		Meals:ko.observableArray(oMeals),
		FormatPrice:function(price){
			return price==0?"Free":"$"+price.toFixed(2);
		},
		Add:function(){
			this.One(this.One()+1);
		}
	}
	
	var vm2={
		Price:ko.observable(0),
		First:ko.observable(oFirst),
		Last:ko.observable(oLast),
		Meals:ko.observableArray(oMeals),
		Name:ko.observable(oData.name),
		Age:ko.observable(oData.age),
		Work:ko.observable(oData.work),
		LastInputValid:ko.observable(true),
		Data:ko.observable(oData),
		Num:ko.observableArray(oNum),
		Array1:ko.observableArray(oArray),
		pd:ko.observable(1),
		produce:['Apple','Banana','Celery','Corn','Orange','Spinach'],
		selectedProduce:ko.observableArray(['Corn','Orange']),
		acceptedNumericValue:ko.observable(123),
    	lastInputWasValid:ko.observable(true),
    	Url:ko.observable(""),
		MyFull:function(){
			return this.First()+this.Last();
		},
		myFunction: function(data, event) {
			console.log(data);
			console.log(event);
            if (event.shiftKey) {
                alert(345);
            } else {
               	alert(444);
            }
        },
        myNum:function(data, event){
        	console.log(data);
			console.log(event.target.className);
        },
        myNum2:function(data, event,index){
        	console.log(event);
        	console.log(data);
			console.log(index);
        }
	}
	
	//监控属性的显示订阅
	vm2.Name.subscribe(function(newValue){
		console.log(newValue+": "+newValue.length);
	})
	
	vm2.pd.subscribe(function(newValue) {
	    alert("The pd's new name is " + newValue);
	});
	
	//当一个observable的属性有初始值(number,string,true/false,null)时，可以使用内置的notifiy,当新的值写入时始终都会得到监控，即使这些值都是相同的
	vm2.pd.extend({ notify: 'always' });
	//为了避免频繁的更新带来的请求代价，可以通过限制监控速率来实现延时监控;
	vm2.pd.extend({rateLimit:2000});		//两秒后执行监控
	vm2.Num.extend({rateLimit:3000});		//延迟3秒监控并更新数组
	
	var oAge=vm2.Age.subscribe(function(newValue){
		if(newValue<100){
			console.log(newValue+": "+newValue);
		}else{
			console.log(newValue+": *************");
			console.log(this);
			//停止订阅
			this.dispose();
		}
	})
	
	var oPrice2=vm2.Price.subscribe(function(newValue){
		if(newValue<100){
			console.log(newValue+": "+newValue);
		}else{
			console.log(newValue+": *************");
			console.log(this);
			//停止订阅
			this.dispose();
		}
	})
	
	//依赖监控属性
	vm.FormatPriceTwo=ko.dependentObservable(function(){
		return this.chosenMeal().extraCost==0?"Free":"$"+this.chosenMeal().extraCost.toFixed(2);
	},vm)
	
	//计算监控属性Computed Observable
	vm2.Full=ko.computed(function(){
		return this.First()+this.Last();
	},vm2)
	
	//防止内存泄露，减少不必要的开销;noify属性强制通知并监控
	vm2.PureFull=ko.pureComputed(function(){
		return this.First()+this.Last();
	},vm2);
	
	vm2.PureFull.subscribe(function(newValue) {
	    alert("The pd's new PureFull is " + newValue);
	});
	
	vm2.PureFull.extend({ notify: 'always' });
	
	vm2.PureFull.extend({ rateLimit:1000 });
	
	vm2.FullName=ko.dependentObservable({
		read:function(){
			return this.First()+this.Last();
		},
		write:function(value){
			this.First(value+"kkkkk");
		}
	},vm2);
	
	//可写的计算监控属性
	vm2.fullName2=ko.pureComputed({
		read:function(){
			return this.First()+" "+this.Last();
		},
		write:function(value){
			var lastSpacePos=value.lastIndexOf(" ");
			if(lastSpacePos>0){
				this.First(value.substring(0,lastSpacePos));
				this.Last(value.substring(lastSpacePos+1));
			}
		}
	},vm2);
	
	vm2.selectedAllProduce=ko.pureComputed({
		read:function(){
			return this.selectedProduce().length===this.produce.length;
		},
		write:function(value){
			this.selectedProduce(value?this.produce.slice(0):[]);
		}
	},vm2);
	
	//依赖监控属性可写
	vm2.FormatPrice2=ko.dependentObservable({
		read:function(){
			return "$"+this.Price().toFixed(2);
		},
		write:function(value){
			var value=parseFloat(value.replace(/[^\.\d]/g,""));
			if(isNaN(value)){
				this.LastInputValid(false);
			}else{
				this.LastInputValid(true);
				this.Price(isNaN(value)?0:value);
			}
		}
	},vm2)
	
	vm2.attemptedValue = ko.pureComputed({
        read: function(){
        	return this.acceptedNumericValue();
        },
        write: function (value) {
            if (isNaN(value))
                this.lastInputWasValid(false);
            else {
                this.lastInputWasValid(true);
                this.acceptedNumericValue(value); // Write to underlying storage
            }
        }
    },vm2);
    
    //依赖项变化时发送请求
    ko.computed(function(){
    	var params={
    		First:this.First(),
    		Last:this.Last(),
    		Num:this.Num(),
    		Price:this.Price.peek()		//peek方法使Price属性的变化被忽略,price属性变化时不会触发此计算属性函数
    	};
    	$.getJSON('one.json',params,function(data){
    		console.log(data.Url+"hhhhhhhhhhhh");
    		vm2.Url(data);
    	})
    },vm2)
    
	ko.applyBindings(vm,document.getElementsByClassName("container1")[0]);
	ko.applyBindings(vm2,document.getElementsByClassName("container2")[0]);
	
	function formatPrice(price){
		return price==0?"Free":"$"+price.toFixed(2);
	}
	
	$(function(){
		vm2.Name("AB").Age(20).Work("mote");
		console.log(vm2.Age);
		
		function getFun1(value){
			console.log(value);
		}
		
		function getFun2(value){
			return value;
		}
		
		getFun2(getFun1(2));
		
	}())
</script>
</body>
</html>



